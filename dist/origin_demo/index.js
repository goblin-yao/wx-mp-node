const Koa = require("koa");
const Router = require("koa-router");
const logger = require("koa-logger");
const bodyParser = require("koa-bodyparser");
const fs = require("fs");
const path = require("path");
const { init: initDB, Counter } = require("./db");
const router = new Router();
const homePage = fs.readFileSync(path.join(__dirname, "index.html"), "utf-8");
router.get("/", async (ctx) => {
    ctx.body = homePage;
});
router.post("/api/count", async (ctx) => {
    const { request } = ctx;
    const { action } = request.body;
    if (action === "inc") {
        await Counter.create();
    }
    else if (action === "clear") {
        await Counter.destroy({
            truncate: true,
        });
    }
    ctx.body = {
        code: 0,
        data: await Counter.count(),
    };
});
router.get("/api/count", async (ctx) => {
    const result = await Counter.count();
    ctx.body = {
        code: 0,
        data: result,
    };
});
router.get("/api/wx_openid", async (ctx) => {
    if (ctx.request.headers["x-wx-source"]) {
        ctx.body = ctx.request.headers["x-wx-openid"];
    }
});
const app = new Koa();
app
    .use(logger())
    .use(bodyParser())
    .use(router.routes())
    .use(router.allowedMethods());
const port = process.env.PORT || 80;
async function bootstrap() {
    await initDB();
    app.listen(port, () => {
        console.log("启动成功", port);
    });
}
bootstrap();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9vcmlnaW5fZGVtby9pbmRleC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDM0IsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ3JDLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUNyQyxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQUM3QyxNQUFNLEVBQUUsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDekIsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzdCLE1BQU0sRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUVsRCxNQUFNLE1BQU0sR0FBRyxJQUFJLE1BQU0sRUFBRSxDQUFDO0FBRTVCLE1BQU0sUUFBUSxHQUFHLEVBQUUsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsWUFBWSxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFHOUUsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxFQUFFO0lBQzVCLEdBQUcsQ0FBQyxJQUFJLEdBQUcsUUFBUSxDQUFDO0FBQ3RCLENBQUMsQ0FBQyxDQUFDO0FBR0gsTUFBTSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxFQUFFO0lBQ3RDLE1BQU0sRUFBRSxPQUFPLEVBQUUsR0FBRyxHQUFHLENBQUM7SUFDeEIsTUFBTSxFQUFFLE1BQU0sRUFBRSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUM7SUFDaEMsSUFBSSxNQUFNLEtBQUssS0FBSyxFQUFFO1FBQ3BCLE1BQU0sT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDO0tBQ3hCO1NBQU0sSUFBSSxNQUFNLEtBQUssT0FBTyxFQUFFO1FBQzdCLE1BQU0sT0FBTyxDQUFDLE9BQU8sQ0FBQztZQUNwQixRQUFRLEVBQUUsSUFBSTtTQUNmLENBQUMsQ0FBQztLQUNKO0lBRUQsR0FBRyxDQUFDLElBQUksR0FBRztRQUNULElBQUksRUFBRSxDQUFDO1FBQ1AsSUFBSSxFQUFFLE1BQU0sT0FBTyxDQUFDLEtBQUssRUFBRTtLQUM1QixDQUFDO0FBQ0osQ0FBQyxDQUFDLENBQUM7QUFHSCxNQUFNLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLEVBQUU7SUFDckMsTUFBTSxNQUFNLEdBQUcsTUFBTSxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUM7SUFFckMsR0FBRyxDQUFDLElBQUksR0FBRztRQUNULElBQUksRUFBRSxDQUFDO1FBQ1AsSUFBSSxFQUFFLE1BQU07S0FDYixDQUFDO0FBQ0osQ0FBQyxDQUFDLENBQUM7QUFHSCxNQUFNLENBQUMsR0FBRyxDQUFDLGdCQUFnQixFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsRUFBRTtJQUN6QyxJQUFJLEdBQUcsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxFQUFFO1FBQ3RDLEdBQUcsQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7S0FDL0M7QUFDSCxDQUFDLENBQUMsQ0FBQztBQUVILE1BQU0sR0FBRyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7QUFDdEIsR0FBRztLQUNBLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQztLQUNiLEdBQUcsQ0FBQyxVQUFVLEVBQUUsQ0FBQztLQUNqQixHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDO0tBQ3BCLEdBQUcsQ0FBQyxNQUFNLENBQUMsY0FBYyxFQUFFLENBQUMsQ0FBQztBQUVoQyxNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxFQUFFLENBQUM7QUFDcEMsS0FBSyxVQUFVLFNBQVM7SUFDdEIsTUFBTSxNQUFNLEVBQUUsQ0FBQztJQUNmLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRTtRQUNwQixPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztJQUM1QixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUM7QUFDRCxTQUFTLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IEtvYSA9IHJlcXVpcmUoXCJrb2FcIik7XG5jb25zdCBSb3V0ZXIgPSByZXF1aXJlKFwia29hLXJvdXRlclwiKTtcbmNvbnN0IGxvZ2dlciA9IHJlcXVpcmUoXCJrb2EtbG9nZ2VyXCIpO1xuY29uc3QgYm9keVBhcnNlciA9IHJlcXVpcmUoXCJrb2EtYm9keXBhcnNlclwiKTtcbmNvbnN0IGZzID0gcmVxdWlyZShcImZzXCIpO1xuY29uc3QgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xuY29uc3QgeyBpbml0OiBpbml0REIsIENvdW50ZXIgfSA9IHJlcXVpcmUoXCIuL2RiXCIpO1xuXG5jb25zdCByb3V0ZXIgPSBuZXcgUm91dGVyKCk7XG5cbmNvbnN0IGhvbWVQYWdlID0gZnMucmVhZEZpbGVTeW5jKHBhdGguam9pbihfX2Rpcm5hbWUsIFwiaW5kZXguaHRtbFwiKSwgXCJ1dGYtOFwiKTtcblxuLy8g6aaW6aG1XG5yb3V0ZXIuZ2V0KFwiL1wiLCBhc3luYyAoY3R4KSA9PiB7XG4gIGN0eC5ib2R5ID0gaG9tZVBhZ2U7XG59KTtcblxuLy8g5pu05paw6K6h5pWwXG5yb3V0ZXIucG9zdChcIi9hcGkvY291bnRcIiwgYXN5bmMgKGN0eCkgPT4ge1xuICBjb25zdCB7IHJlcXVlc3QgfSA9IGN0eDtcbiAgY29uc3QgeyBhY3Rpb24gfSA9IHJlcXVlc3QuYm9keTtcbiAgaWYgKGFjdGlvbiA9PT0gXCJpbmNcIikge1xuICAgIGF3YWl0IENvdW50ZXIuY3JlYXRlKCk7XG4gIH0gZWxzZSBpZiAoYWN0aW9uID09PSBcImNsZWFyXCIpIHtcbiAgICBhd2FpdCBDb3VudGVyLmRlc3Ryb3koe1xuICAgICAgdHJ1bmNhdGU6IHRydWUsXG4gICAgfSk7XG4gIH1cblxuICBjdHguYm9keSA9IHtcbiAgICBjb2RlOiAwLFxuICAgIGRhdGE6IGF3YWl0IENvdW50ZXIuY291bnQoKSxcbiAgfTtcbn0pO1xuXG4vLyDojrflj5borqHmlbBcbnJvdXRlci5nZXQoXCIvYXBpL2NvdW50XCIsIGFzeW5jIChjdHgpID0+IHtcbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgQ291bnRlci5jb3VudCgpO1xuXG4gIGN0eC5ib2R5ID0ge1xuICAgIGNvZGU6IDAsXG4gICAgZGF0YTogcmVzdWx0LFxuICB9O1xufSk7XG5cbi8vIOWwj+eoi+W6j+iwg+eUqO+8jOiOt+WPluW+ruS/oSBPcGVuIElEXG5yb3V0ZXIuZ2V0KFwiL2FwaS93eF9vcGVuaWRcIiwgYXN5bmMgKGN0eCkgPT4ge1xuICBpZiAoY3R4LnJlcXVlc3QuaGVhZGVyc1tcIngtd3gtc291cmNlXCJdKSB7XG4gICAgY3R4LmJvZHkgPSBjdHgucmVxdWVzdC5oZWFkZXJzW1wieC13eC1vcGVuaWRcIl07XG4gIH1cbn0pO1xuXG5jb25zdCBhcHAgPSBuZXcgS29hKCk7XG5hcHBcbiAgLnVzZShsb2dnZXIoKSlcbiAgLnVzZShib2R5UGFyc2VyKCkpXG4gIC51c2Uocm91dGVyLnJvdXRlcygpKVxuICAudXNlKHJvdXRlci5hbGxvd2VkTWV0aG9kcygpKTtcblxuY29uc3QgcG9ydCA9IHByb2Nlc3MuZW52LlBPUlQgfHwgODA7XG5hc3luYyBmdW5jdGlvbiBib290c3RyYXAoKSB7XG4gIGF3YWl0IGluaXREQigpO1xuICBhcHAubGlzdGVuKHBvcnQsICgpID0+IHtcbiAgICBjb25zb2xlLmxvZyhcIuWQr+WKqOaIkOWKn1wiLCBwb3J0KTtcbiAgfSk7XG59XG5ib290c3RyYXAoKTtcbiJdfQ==